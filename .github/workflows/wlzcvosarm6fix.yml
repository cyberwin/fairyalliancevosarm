
name: ä¸œæ–¹ä»™ç›ŸèŠ¯ç‰‡å¹»å¢ƒ7

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            cef_dir: CEF_AMD64
            cef_url: https://cef-builds.spotifycdn.com/cef_binary_108.4.13%2Bga98cd4c%2Bchromium-108.0.5359.125_linux64.tar.bz2
          - arch: arm64
            cef_dir: CEF_ARM64
            cef_url: https://xxx.com/cef_binary_xxx_linuxarm64.tar.bz2 # æ›¿æ¢ä¸ºçœŸå®ARM64 CEFåœ°å€
    continue-on-error: false

    steps:
      - name: æ‹‰å–GitHubä»“åº“æºç 
        uses: actions/checkout@v4
        with:
          persist-credentials: true # ä¿ç•™å‡­è¯ï¼Œç”¨äºåç»­æäº¤ä»£ç 

      - name: å®‰è£…ç¼–è¯‘ä¾èµ– + Gité…ç½®
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends \
            g++ gcc-aarch64-linux-gnu g++-aarch64-linux-gnu wget unzip
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼Œç”¨äºæäº¤CEFç›®å½•
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          # éªŒè¯ç¼–è¯‘å™¨
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            g++ --version || exit 1
          else
            aarch64-linux-gnu-g++ --version || exit 1
          fi

      - name: ğŸš¨ æ£€æµ‹CEFç›®å½•æ˜¯å¦å­˜åœ¨ + é¦–æ¬¡è‡ªåŠ¨ä¸‹è½½å¤´æ–‡ä»¶å¹¶æäº¤
        run: |
          CEF_DIR=${{ matrix.cef_dir }}
          CEF_INCLUDE=$CEF_DIR/include
          # æ£€æµ‹å¤´æ–‡ä»¶ç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆåˆ¤æ–­æ˜¯å¦é¦–æ¬¡è¿è¡Œï¼‰
          if [ ! -d "$CEF_INCLUDE" ]; then
            echo "é¦–æ¬¡è¿è¡Œï¼š$CEF_DIR ç›®å½•ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½å¹¶åˆ›å»º..."
            # åˆ›å»ºç›®å½•ç»“æ„
            mkdir -p $CEF_INCLUDE $CEF_DIR/lib
            # ä¸‹è½½CEFå®Œæ•´åŒ…
            wget -q --timeout=30 --tries=3 ${{ matrix.cef_url }} -O $CEF_DIR/cef_full.tar.bz2
            if [ ! -f $CEF_DIR/cef_full.tar.bz2 ]; then
              echo "CEFåŒ…ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            # è§£å‹å‡ºå¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶
            mkdir -p $CEF_DIR/tmp
            tar -xjf $CEF_DIR/cef_full.tar.bz2 -C $CEF_DIR/tmp --strip-components=1
            cp -r $CEF_DIR/tmp/include/* $CEF_INCLUDE/
            cp -r $CEF_DIR/tmp/lib/* $CEF_DIR/lib/
            cp -f $CEF_DIR/tmp/libcef.so $CEF_DIR/lib/
            # å…¼å®¹cef_helper
            if [ -f $CEF_DIR/tmp/Release/cef_helper ]; then
              cp $CEF_DIR/tmp/Release/cef_helper $CEF_DIR/lib/
            elif [ -f $CEF_DIR/tmp/Release/chrome-sandbox ]; then
              cp $CEF_DIR/tmp/Release/chrome-sandbox $CEF_DIR/lib/cef_helper
            fi
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf $CEF_DIR/tmp $CEF_DIR/cef_full.tar.bz2
            # æäº¤åˆ°GitHubä»“åº“
            git add $CEF_DIR/
            git commit -m "chore: é¦–æ¬¡æ·»åŠ  $CEF_DIR å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶"
            git push origin main
            echo "$CEF_DIR å·²æˆåŠŸæäº¤åˆ°GitHubä»“åº“"
          else
            echo "$CEF_DIR ç›®å½•å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½æ­¥éª¤"
          fi

      - name: ğŸ› ï¸ ç¼–è¯‘ ${{ matrix.arch }} æ¶æ„ç¨‹åº
        run: |
          CEF_DIR=${{ matrix.cef_dir }}
          mkdir -p output/${{ matrix.arch }}

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            CXX=$(which g++)
          else
            CXX=$(which aarch64-linux-gnu-g++)
          fi

          $CXX -std=c++17 -fPIC -Wall -static-libstdc++ -Wl,-rpath=./ \
            -I./include \
            -I$CEF_DIR/include \
            src/main.cpp src/config_parser.cpp src/global_context.cpp src/cyber_browser.cpp src/cyber_v8_handler.cpp src/ini.c \
            -L$CEF_DIR/lib -lcef -lpthread -ldl -lrt -lm -lX11 \
            -o output/${{ matrix.arch }}/CyberWinBrowser

          # æ‹·è´è¿è¡Œä¾èµ–
          cp $CEF_DIR/lib/libcef.so output/${{ matrix.arch }}/
          if [ -f $CEF_DIR/lib/cef_helper ]; then
            cp $CEF_DIR/lib/cef_helper output/${{ matrix.arch }}/
          fi

          # éªŒè¯äº§ç‰©
          if [ ! -f output/${{ matrix.arch }}/CyberWinBrowser ]; then
            echo "ç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ä¸œæ–¹ä»™ç›Ÿæµè§ˆå™¨-${{ matrix.arch }}
          path: output/${{ matrix.arch }}/
          retention-days: 30
