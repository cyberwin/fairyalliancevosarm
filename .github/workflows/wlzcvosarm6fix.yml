name: ä¸œæ–¹ä»™ç›ŸèŠ¯ç‰‡å¹»å¢ƒ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            cef_dir: CEF_AMD64
            cef_url: https://cef-builds.spotifycdn.com/cef_binary_108.4.13%2Bga98cd4c%2Bchromium-108.0.5359.125_linux64.tar.bz2
          - arch: arm64
            cef_dir: CEF_ARM64
            # æ›¿æ¢ä¸ºçœŸå®å¯ç”¨çš„ ARM64 ç‰ˆ CEF ä¸‹è½½åœ°å€ï¼ˆç¤¾åŒºé€‚é…å›½äº§ç³»ç»Ÿç‰ˆæœ¬æœ€ä½³ï¼‰
            cef_url: https://xxx.com/cef_binary_xxx_linuxarm64.tar.bz2
    continue-on-error: false

    steps:
      - name: æ‹‰å–æºç 
        uses: actions/checkout@v4

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y --no-install-recommends \
            g++ \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            wget \
            unzip
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            g++ --version || exit 1
          else
            aarch64-linux-gnu-g++ --version || exit 1
          fi

      - name: ğŸ”§ åˆ›å»ºç‹¬ç«‹ CEF æ¶æ„ç›®å½• + è‡ªåŠ¨æ”¾å…¥å¤´æ–‡ä»¶/åº“æ–‡ä»¶
        run: |
          # å®šä¹‰å½“å‰æ¶æ„çš„ CEF ç›®å½•ï¼ˆæ ¹ç›®å½•ä¸‹çš„ CEF_AMD64 / CEF_ARM64ï¼‰
          CEF_DIR=${{ matrix.cef_dir }}
          # åˆ›å»ºç›®å½•ç»“æ„ï¼šinclude æ”¾å¤´æ–‡ä»¶ï¼Œlib æ”¾åº“æ–‡ä»¶
          mkdir -p $CEF_DIR/include $CEF_DIR/lib
          echo "å·²åˆ›å»ºç‹¬ç«‹ CEF ç›®å½•: $CEF_DIR"

          # ä¸‹è½½å¯¹åº”æ¶æ„ CEF é¢„ç¼–è¯‘åŒ…
          wget -q --timeout=30 --tries=3 ${{ matrix.cef_url }} -O $CEF_DIR/cef.tar.bz2
          if [ ! -f $CEF_DIR/cef.tar.bz2 ]; then
            echo "CEF åŒ…ä¸‹è½½å¤±è´¥"
            exit 1
          fi

          # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p $CEF_DIR/tmp
          tar -xjf $CEF_DIR/cef.tar.bz2 -C $CEF_DIR/tmp --strip-components=1

          # æ ¸å¿ƒï¼šå°†å®˜æ–¹å¤´æ–‡ä»¶ã€åº“æ–‡ä»¶æ‹·è´åˆ°å¯¹åº”ç›®å½•
          cp -r $CEF_DIR/tmp/include/* $CEF_DIR/include/
          cp -r $CEF_DIR/tmp/lib/* $CEF_DIR/lib/
          # ç¡®ä¿ libcef.so å­˜åœ¨
          if [ -f $CEF_DIR/tmp/libcef.so ]; then
            cp $CEF_DIR/tmp/libcef.so $CEF_DIR/lib/
          fi

          # å…¼å®¹å­è¿›ç¨‹æ–‡ä»¶
          if [ -f $CEF_DIR/tmp/Release/cef_helper ]; then
            cp $CEF_DIR/tmp/Release/cef_helper $CEF_DIR/lib/
          elif [ -f $CEF_DIR/tmp/Release/chrome-sandbox ]; then
            cp $CEF_DIR/tmp/Release/chrome-sandbox $CEF_DIR/lib/cef_helper
          fi

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf $CEF_DIR/tmp $CEF_DIR/cef.tar.bz2
          echo "$CEF_DIR ç›®å½•å·²æ”¾å…¥å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶"

      - name: ğŸ› ï¸ ç¼–è¯‘ ${{ matrix.arch }} æ¶æ„ç¨‹åº
        run: |
          CEF_DIR=${{ matrix.cef_dir }}
          mkdir -p output/${{ matrix.arch }}

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            CXX=$(which g++)
          else
            CXX=$(which aarch64-linux-gnu-g++)
          fi

          $CXX -std=c++17 -fPIC -Wall -static-libstdc++ -Wl,-rpath=./ \
            -I./include \
            -I$CEF_DIR/include \  # å¼•ç”¨å½“å‰æ¶æ„çš„ CEF å¤´æ–‡ä»¶
            src/main.cpp src/config_parser.cpp src/global_context.cpp src/cyber_browser.cpp src/cyber_v8_handler.cpp src/ini.c \
            -L$CEF_DIR/lib -lcef -lpthread -ldl -lrt -lm -lX11 \  # é“¾æ¥å½“å‰æ¶æ„çš„ CEF åº“
            -o output/${{ matrix.arch }}/CyberWinBrowser

          # æ‹·è´è¿è¡Œæ—¶ä¾èµ–
          cp $CEF_DIR/lib/libcef.so output/${{ matrix.arch }}/
          if [ -f $CEF_DIR/lib/cef_helper ]; then
            cp $CEF_DIR/lib/cef_helper output/${{ matrix.arch }}/
          fi

          # éªŒè¯äº§ç‰©
          if [ ! -f output/${{ matrix.arch }}/CyberWinBrowser ]; then
            echo "ç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ä¸œæ–¹ä»™ç›Ÿæµè§ˆå™¨-${{ matrix.arch }}
          path: output/${{ matrix.arch }}/
          retention-days: 30
