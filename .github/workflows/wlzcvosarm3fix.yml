name: 东方仙盟芯片双架构编译

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [amd64, arm64]
    continue-on-error: false

    steps:
      - name: 拉取源码
        uses: actions/checkout@v4

      - name: 安装编译依赖（修复 ARM64 编译器）
        run: |
          sudo apt update -y
          # 明确安装 ARM64 交叉编译工具链完整包
          sudo apt install -y --no-install-recommends \
            g++ \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            wget \
            unzip
          # 验证编译器是否安装成功
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            g++ --version || { echo "g++ 安装失败"; exit 1; }
          else
            aarch64-linux-gnu-g++ --version || { echo "aarch64-linux-gnu-g++ 安装失败"; exit 1; }
          fi

      - name: 下载对应架构 CEF 预编译库
        run: |
          mkdir -p lib/${{ matrix.arch }}
          cd lib/${{ matrix.arch }}

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            CEF_URL="https://cef-builds.spotifycdn.com/cef_binary_108.4.13%2Bga98cd4c%2Bchromium-108.0.5359.125_linux64.tar.bz2"
          else
            CEF_URL="https://cef-builds.spotifycdn.com/cef_binary_110.0.18%2Bg877cbe7%2Bchromium-110.0.5481.30_linuxarm64_beta.tar.bz2"
          fi

          wget -q --timeout=30 --tries=3 $CEF_URL -O cef.tar.bz2
          if [ ! -f cef.tar.bz2 ]; then
            echo "CEF 库下载失败"
            exit 1
          fi
          tar -xjf cef.tar.bz2 --strip-components=1
          
          if [ -f "Release/libcef.so" ]; then
            cp Release/libcef.so ./
          elif [ -f "libcef.so" ]; then
            cp libcef.so ./
          else
            echo "未找到 libcef.so"
            exit 1
          fi
          
          if [ -f "Release/cef_helper" ]; then
            cp Release/cef_helper ./
          elif [ -f "Release/chrome-sandbox" ]; then
            cp Release/chrome-sandbox ./cef_helper
          elif [ -f "chrome-sandbox" ]; then
            cp chrome-sandbox ./cef_helper
          fi
          cd ../..
        shell: /usr/bin/bash -e {0}

      - name: 编译 ${{ matrix.arch }} 架构程序
        run: |
          mkdir -p output/${{ matrix.arch }}
          # 显式指定编译器路径，防止命令找不到
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            CXX=$(which g++)
          else
            CXX=$(which aarch64-linux-gnu-g++)
          fi

          $CXX -std=c++17 -fPIC -Wall -static-libstdc++ -Wl,-rpath=./ \
            -I./include \
            -I./include/cef \
            -I./include/cef/internal \
            src/main.cpp src/config_parser.cpp src/global_context.cpp src/cyber_browser.cpp src/cyber_v8_handler.cpp src/ini.c \
            -L./lib/${{ matrix.arch }} -lcef -lpthread -ldl -lrt -lm \
            -o output/${{ matrix.arch }}/CyberWinBrowser

          if [ -f "lib/${{ matrix.arch }}/libcef.so" ]; then
            cp lib/${{ matrix.arch }}/libcef.so output/${{ matrix.arch }}/
          fi
          if [ -f "lib/${{ matrix.arch }}/cef_helper" ]; then
            cp lib/${{ matrix.arch }}/cef_helper output/${{ matrix.arch }}/
          fi
          
          if [ ! -f output/${{ matrix.arch }}/CyberWinBrowser ]; then
            echo "编译失败，未生成可执行文件"
            exit 1
          fi
        shell: /usr/bin/bash -e {0}

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: 东方仙盟浏览器-${{ matrix.arch }}
          path: output/${{ matrix.arch }}/
          retention-days: 30

